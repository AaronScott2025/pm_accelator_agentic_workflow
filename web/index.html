<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interviewer PM - Behavioral Interview Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-success:hover:not(:disabled) {
            box-shadow: 0 5px 20px rgba(56, 239, 125, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideIn 0.3s;
        }
        
        .question-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border-left: 4px solid #667eea;
        }
        
        .question-box p {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .category-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin: 10px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .feedback-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #11998e;
            line-height: 1.8;
            font-size: 15px;
        }
        
        .feedback-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .feedback-content h3 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        
        .feedback-content ol, .feedback-content ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .feedback-content li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .feedback-content strong {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .feedback-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feedback-section h4::before {
            content: "üí°";
            font-size: 1.5rem;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .score-item:hover {
            transform: translateX(5px);
        }
        
        .score-item span:first-child {
            font-weight: 600;
            text-transform: capitalize;
            color: #2c3e50;
        }
        
        .score-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        
        .score-value.high {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .score-value.medium {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }
        
        .score-value.low {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
        }
        
        .loading::after {
            content: "‚è≥";
            font-size: 3rem;
            animation: spin 2s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            color: #2c3e50;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .scores-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .summary-box {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #e0e6ed 0%, #f5f7fa 100%);
            border-radius: 12px;
            border-left: 4px solid #764ba2;
        }
        
        .summary-box strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .followups-container {
            background: #fff5f5;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #f5576c;
        }
        
        .followups-container ul {
            list-style: none;
            padding: 0;
        }
        
        .followups-container li {
            padding: 12px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            padding-left: 35px;
        }
        
        .followups-container li::before {
            content: "‚ùì";
            position: absolute;
            left: 12px;
            top: 12px;
        }
        
        .example-answer-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .example-answer-box h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .example-answer-box h4::before {
            content: "‚ú®";
            font-size: 1.5rem;
        }
        
        .example-answer-content {
            color: #2c3e50;
            line-height: 1.8;
            font-style: italic;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .improvement-tips-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        
        .improvement-tips-box h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .improvement-tips-box h4::before {
            content: "üí°";
            font-size: 1.5rem;
        }
        
        .improvement-tip {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid #ff9800;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .refinement-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #2196f3;
        }
        
        .refinement-section h3 {
            color: #1565c0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .refinement-section h3::before {
            content: "üîÑ";
            font-size: 1.5rem;
        }
        
        .refinement-count {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .btn-refine {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .btn-refine:hover:not(:disabled) {
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
        }
        
        .progress-indicator {
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #667eea;
        }

        .rubric-section {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #cbd5e0;
        }

        .rubric-title {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ragas-container, .judge-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .ragas-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .judge-rationale {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #28a745;
            font-style: italic;
            line-height: 1.6;
        }
        
        .rubric-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .rubric-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .rubric-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .rubric-label {
            flex: 0 0 200px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        
        .rubric-score-bar {
            flex: 1;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .rubric-score-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .rubric-score-fill.high {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .rubric-score-fill.medium {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }
        
        .rubric-score-fill.low {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .rubric-score-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .rubric-score-value {
            flex: 0 0 70px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 20px;
            color: white;
        }
        
        .rubric-score-value.high {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .rubric-score-value.medium {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }
        
        .rubric-score-value.low {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* New styles for enhanced evaluations */
        .grail-section {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4e8fc 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #a8d0f0;
        }
        
        .grail-component {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .grail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .grail-title {
            font-weight: 600;
            color: #2c3e50;
            text-transform: uppercase;
            font-size: 14px;
        }
        
        .grail-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .grail-level.exceptional { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .grail-level.strong { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; }
        .grail-level.proficient { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); color: white; }
        .grail-level.developing { background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); color: white; }
        .grail-level.weak { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        
        .agent-evaluations {
            background: linear-gradient(135deg, #fef9e7 0%, #fcf3cf 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #f4e6b9;
        }
        
        .agent-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f39c12;
        }
        
        .agent-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .agent-confidence {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            background: #e8f5e9;
            color: #2e7d32;
            margin-left: 10px;
        }
        
        .consensus-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #4caf50;
        }
        
        .adaptive-decision {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        
        .adaptive-action {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 10px;
        }
        
        .coaching-feedback {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #9c27b0;
        }
        
        .coaching-pattern {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #9c27b0;
        }
        
        .performance-metrics {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 15px 0;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e6ed;
        }
        
        .metric-label {
            font-weight: 600;
            color: #5a6c7d;
        }
        
        .trend-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .trend-badge.improving { background: #d4edda; color: #155724; }
        .trend-badge.stable { background: #fff3cd; color: #856404; }
        .trend-badge.declining { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ AI Interview Coach</h1>
            <p class="subtitle">Master behavioral interviews with personalized AI feedback</p>
        </div>
        
        <div id="error-container"></div>
        <div id="success-container"></div>
        
        <!-- Start Screen -->
        <div id="start-screen" class="card">
            <h2 style="margin-bottom: 20px;">üöÄ Ready to Practice?</h2>
            <p style="margin: 20px 0; font-size: 1.1rem; color: #5a6c7d;">
                Experience real PM interview questions with instant AI-powered feedback, scoring, and personalized coaching tips.
            </p>
            <button class="btn" onclick="startInterview()">Start Interview Session</button>
        </div>
        
        <!-- Question Screen -->
        <div id="question-screen" class="card hidden">
            <div class="progress-indicator" id="question-number"></div>
            <span id="category-badge" class="category-badge"></span>
            <div class="question-box">
                <p id="question-text"></p>
            </div>
            <div style="margin: 20px 0;">
                <label for="answer" style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">
                    üìù Your Response:
                </label>
                <textarea id="answer" placeholder="Structure your response using the STAR method (Situation, Task, Action, Result)..."></textarea>
            </div>
            <button class="btn btn-success" onclick="submitAnswer()">Submit Answer</button>
        </div>
        
        <!-- Evaluation Screen -->
        <div id="evaluation-screen" class="card hidden">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">üìä Your Evaluation</h2>
            
            <!-- Feedback Section -->
            <div style="margin: 20px 0;">
                <div class="feedback-section">
                    <h4>Personalized Feedback</h4>
                    <div id="feedback" class="feedback-content"></div>
                </div>
            </div>
            
            <!-- Template Answer Section -->
            <div id="template-answer-section" class="hidden">
                <div class="example-answer-box">
                    <h4>Template Answer</h4>
                    <div id="template-answer" class="example-answer-content"></div>
                </div>
            </div>
            
            <!-- Improvement Tips Section -->
            <div id="improvement-tips-section" class="hidden">
                <div class="improvement-tips-box">
                    <h4>Improvement Tips</h4>
                    <div id="improvement-tips"></div>
                </div>
            </div>
            
            <!-- Scores Section -->
            <div id="scores-section" class="hidden">
                <h3 class="section-title">üìà Performance Scores</h3>
                <div class="scores-container">
                    <div id="scores"></div>
                </div>
            </div>

            <!-- RAGAS Metrics Section -->
            <div id="ragas-section" class="hidden">
                <h3 class="section-title">üìä RAGAS Evaluation</h3>
                <div class="ragas-container">
                    <div id="ragas-metrics"></div>
                </div>
            </div>

            <!-- LLM-as-Judge Section -->
            <div id="judge-section" class="hidden">
                <h3 class="section-title">‚öñÔ∏è LLM-as-Judge Assessment</h3>
                <div class="judge-container">
                    <div id="judge-score" class="score-item"></div>
                    <div id="judge-rationale" class="judge-rationale"></div>
                </div>
            </div>
            
            <!-- GRAIL Evaluation Section -->
            <div id="grail-section" class="grail-section hidden">
                <h3 class="section-title">üéØ GRAIL Framework Evaluation</h3>
                <div id="grail-components"></div>
                <div id="grail-overall" class="summary-box" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Multi-Agent Consensus Section -->
            <div id="consensus-section" class="agent-evaluations hidden">
                <h3 class="section-title">ü§ù Multi-Agent Evaluation</h3>
                <div id="agent-evaluations"></div>
                <div id="consensus-result" class="consensus-box"></div>
            </div>
            
            <!-- Adaptive Decision Section -->
            <div id="adaptive-section" class="adaptive-decision hidden">
                <h3 class="section-title">üéÆ Adaptive Interview Decision</h3>
                <div id="adaptive-content"></div>
            </div>
            
            <!-- Coaching Feedback Section -->
            <div id="coaching-section" class="coaching-feedback hidden">
                <h3 class="section-title">üë©‚Äçüè´ Dr. Nancy's Coaching Insights</h3>
                <div id="coaching-content"></div>
                <div id="coaching-patterns" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Performance Metrics Section -->
            <div id="performance-section" class="performance-metrics hidden">
                <h3 class="section-title">üìà Performance Analytics</h3>
                <div id="performance-content"></div>
            </div>

            <!-- Follow-ups Section -->
            <div id="followups-section" class="hidden">
                <h3 class="section-title">üé§ Follow-up Questions</h3>
                <div class="followups-container">
                    <ul id="followups"></ul>
                </div>
            </div>
            
            <!-- Refinement Section -->
            <div id="refinement-section" class="refinement-section hidden">
                <h3>
                    Refine Your Answer
                    <span id="refinement-count-badge" class="refinement-count"></span>
                </h3>
                <p style="margin-bottom: 15px; color: #424242;">
                    Based on the feedback, you can refine your answer to improve your score. 
                    Use the improvement tips and template answer as guides.
                </p>
                <textarea id="refined-answer" placeholder="Refine your answer incorporating the feedback..."
                    style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #2196f3; 
                    border-radius: 8px; font-size: 16px;"></textarea>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-refine" onclick="submitRefinedAnswer()">Submit Refined Answer</button>
                    <button class="btn btn-secondary" onclick="skipRefinement()">Continue Without Refining</button>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="button-group" id="main-buttons">
                <button id="refine-btn" class="btn btn-refine hidden" onclick="showRefinementSection()">üîÑ Refine Answer</button>
                <button id="next-btn" class="btn btn-success" onclick="nextQuestion()">Next Question ‚Üí</button>
                <button id="new-interview-btn" class="btn hidden" onclick="resetInterview()">üéâ Start New Interview</button>
                <button class="btn btn-secondary" onclick="resetInterview()">End Session</button>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <p style="font-size: 1.2rem; margin-top: 20px;">Analyzing your response...</p>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8080';
        let sessionId = '';
        let currentQuestion = null;
        let interviewComplete = false;
        let currentAnswer = '';
        let refinementCount = 0;
        let maxRefinements = 2;
        
        // Example answers for common PM behavioral categories
        const exampleAnswers = {
            'leadership': 'Using STAR: Situation - Led cross-functional team during product pivot. Task - Align engineering, design, and marketing on new direction. Action - Conducted stakeholder interviews, created shared vision doc, ran weekly syncs. Result - Delivered MVP 2 weeks ahead, 40% user adoption in first month.',
            'product sense': 'Using STAR: Situation - Users complained about complex onboarding. Task - Simplify without losing key features. Action - Analyzed drop-off data, conducted user interviews, A/B tested 3 versions. Result - Reduced time-to-value by 60%, increased activation rate by 35%.',
            'execution': 'Using STAR: Situation - Feature launch delayed by dependencies. Task - Deliver value despite blockers. Action - Decomposed feature into phases, shipped MVP early, iterated based on feedback. Result - Captured 80% of value in half the time, unblocked team progress.',
            'strategy': 'Using STAR: Situation - Entering competitive market segment. Task - Define differentiation strategy. Action - Analyzed competitor gaps, interviewed churned users, identified underserved niche. Result - Captured 15% market share in 6 months by focusing on SMB segment.',
            'teamwork': 'Using STAR: Situation - Conflict between engineering and design teams. Task - Restore collaboration. Action - Facilitated joint workshop, established shared principles, created decision framework. Result - Reduced revision cycles by 50%, improved team NPS by 30 points.',
            'analytics': 'Using STAR: Situation - Feature performing below expectations. Task - Diagnose root cause. Action - Built funnel analysis, segmented user cohorts, identified friction points. Result - Fixed 3 UX issues, increased conversion by 25% in 2 weeks.'
        };
        
        function getExampleAnswer(category) {
            const lowerCategory = category.toLowerCase();
            for (const [key, value] of Object.entries(exampleAnswers)) {
                if (lowerCategory.includes(key) || key.includes(lowerCategory)) {
                    return value;
                }
            }
            return 'Focus on STAR method: Clearly describe the Situation, define your Task/responsibility, explain specific Actions you took, and quantify the Results achieved. Use metrics and specific examples to demonstrate impact.';
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successContainer = document.getElementById('success-container');
            successContainer.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
            setTimeout(() => {
                successContainer.innerHTML = '';
            }, 5000);
        }
        
        function showScreen(screenId) {
            const screens = ['start-screen', 'question-screen', 'evaluation-screen', 'loading'];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (id === screenId) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            });
        }
        
        async function startInterview() {
            showScreen('loading');
            
            try {
                console.log('Starting interview...');
                const response = await fetch(`${API_URL}/behavioral/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        total_questions: 5,
                        difficulty: 'senior'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Start interview failed:', errorText);
                    throw new Error(`Failed to start interview: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Interview started:', data);
                sessionId = data.session_id;
                currentQuestion = data.question;
                
                displayQuestion();
                showSuccess('Interview started! Good luck!');
                showScreen('question-screen');
            } catch (error) {
                console.error('Error starting interview:', error);
                showError(error.message || 'Failed to start interview');
                showScreen('start-screen');
            }
        }
        
        function displayQuestion() {
            if (!currentQuestion) return;
            
            document.getElementById('question-number').textContent = 
                `Question ${currentQuestion.question_index + 1} of ${currentQuestion.total_questions}`;
            document.getElementById('category-badge').textContent = currentQuestion.category;
            document.getElementById('question-text').textContent = currentQuestion.question;
            document.getElementById('answer').value = '';
        }
        
        async function submitAnswer() {
            const answer = document.getElementById('answer').value.trim();
            
            if (!answer) {
                showError('Please provide an answer before submitting');
                return;
            }
            
            currentAnswer = answer;  // Store for potential refinement
            showScreen('loading');
            
            try {
                console.log('Submitting answer...');
                const response = await fetch(`${API_URL}/behavioral/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: answer,
                        options: {
                            k: 5,
                            prefer_coach: true,
                            do_judge: true,
                            do_ragas: true
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Submit answer failed:', errorText);
                    throw new Error(`Failed to submit answer: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Answer evaluated:', data);
                
                displayEvaluation(data.evaluation, data);
                interviewComplete = data.interview_completed;
                
                if (data.next_question && !data.interview_completed) {
                    currentQuestion = data.next_question;
                }
                
                showSuccess('Answer evaluated successfully!');
                showScreen('evaluation-screen');
            } catch (error) {
                console.error('Error submitting answer:', error);
                showError(error.message || 'Failed to submit answer');
                showScreen('question-screen');
            }
        }
        
        function formatFeedback(text) {
            // Split the text to handle the rubric section separately
            const rubricIndex = text.indexOf('### Feedback Rubric:');
            
            if (rubricIndex !== -1) {
                // Split into main feedback and rubric
                const mainFeedback = text.substring(0, rubricIndex).trim();
                const rubricText = text.substring(rubricIndex).trim();
                
                // Format main feedback
                let formattedMain = mainFeedback
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\n\n/g, '</p><p>')  // Paragraphs
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
                
                // Format rubric section
                let formattedRubric = '<div class="rubric-section">';
                formattedRubric += '<h3 class="rubric-title">üìä Feedback Rubric</h3>';
                formattedRubric += '<div class="rubric-items">';
                
                // Parse rubric items (lines starting with - or *)
                const rubricLines = rubricText.split('\n').slice(1); // Skip the header line
                let currentItem = '';
                
                for (const line of rubricLines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('-') || trimmedLine.startsWith('*')) {
                        // Save previous item if exists
                        if (currentItem) {
                            const [label, score] = parseRubricItem(currentItem);
                            if (label && score) {
                                formattedRubric += createRubricItem(label, score);
                            }
                        }
                        // Start new item
                        currentItem = trimmedLine.substring(1).trim();
                    } else if (trimmedLine && currentItem) {
                        // Continuation of current item
                        currentItem += ' ' + trimmedLine;
                    }
                }
                
                // Don't forget the last item
                if (currentItem) {
                    const [label, score] = parseRubricItem(currentItem);
                    if (label && score) {
                        formattedRubric += createRubricItem(label, score);
                    }
                }
                
                formattedRubric += '</div></div>';
                
                return formattedMain + formattedRubric;
            } else {
                // No rubric section, format normally
                return text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\n\n/g, '</p><p>')  // Paragraphs
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
            }
        }
        
        function parseRubricItem(item) {
            // Parse items like "Structure: 4/5" or "STAR Method Usage - 3.5/5"
            const patterns = [
                /^(.+?):\s*([0-9.]+)\s*\/\s*([0-9.]+)/,  // Pattern: "Label: X/Y"
                /^(.+?)\s*[-‚Äì]\s*([0-9.]+)\s*\/\s*([0-9.]+)/,  // Pattern: "Label - X/Y"
                /^(.+?)\s+([0-9.]+)\s*\/\s*([0-9.]+)/  // Pattern: "Label X/Y"
            ];
            
            for (const pattern of patterns) {
                const match = item.match(pattern);
                if (match) {
                    return [match[1].trim(), parseFloat(match[2])];
                }
            }
            
            return [null, null];
        }
        
        function createRubricItem(label, score) {
            // Determine score level for styling
            let scoreClass = 'low';
            if (score >= 8) scoreClass = 'high';
            else if (score >= 6) scoreClass = 'medium';
            
            return `
                <div class="rubric-item">
                    <span class="rubric-label">${label}</span>
                    <div class="rubric-score-bar">
                        <div class="rubric-score-fill ${scoreClass}" style="width: ${(score/10)*100}%"></div>
                    </div>
                    <span class="rubric-score-value ${scoreClass}">${score.toFixed(1)}/10.0</span>
                </div>
            `;
        }
        
        function displayEvaluation(evaluation, fullResponse) {
            if (!evaluation) return;
            
            // Store response data for refinement
            const improvementTips = fullResponse?.improvement_tips || [];
            const refinementAllowed = fullResponse?.refinement_allowed || false;
            refinementCount = fullResponse?.refinement_count || 0;
            
            // Display new enhanced evaluations
            displayGRAILEvaluation(evaluation.grail_evaluation);
            displayConsensusEvaluation(evaluation.consensus_evaluation);
            displayAdaptiveDecision(evaluation.adaptive_decision);
            displayCoachingFeedback(evaluation.coaching_feedback);
            displayPerformanceMetrics(fullResponse?.performance_metrics);
            
            // Display feedback with proper formatting
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = formatFeedback(evaluation.feedback);
            
            // Display template answer from API or fallback
            const templateAnswerSection = document.getElementById('template-answer-section');
            const templateAnswerDiv = document.getElementById('template-answer');
            
            if (evaluation.template_answer) {
                // Use template answer from API
                templateAnswerSection.classList.remove('hidden');
                templateAnswerDiv.innerHTML = formatFeedback(evaluation.template_answer);
            } else if (currentQuestion && currentQuestion.category) {
                // Fallback to client-side example
                templateAnswerSection.classList.remove('hidden');
                templateAnswerDiv.textContent = getExampleAnswer(currentQuestion.category);
            }
            
            // Display scores
            if (evaluation.rubric_score && Object.keys(evaluation.rubric_score).length > 0) {
                const scoresSection = document.getElementById('scores-section');
                const scoresContainer = document.getElementById('scores');
                let hasScores = false;
                let summary = null;
                
                scoresContainer.innerHTML = '';
                for (const [key, value] of Object.entries(evaluation.rubric_score)) {
                    if (key === 'summary' && typeof value === 'string') {
                        summary = value;
                        continue;
                    }
                    // Skip other non-numeric fields
                    if (typeof value !== 'number') {
                        continue;
                    }
                    hasScores = true;
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    
                    // Determine score level for color coding
                    let scoreClass = 'low';
                    if (value >= 8) scoreClass = 'high';
                    else if (value >= 6) scoreClass = 'medium';

                    scoreItem.innerHTML = `
                        <span>${key.replace(/_/g, ' ')}</span>
                        <span class="score-value ${scoreClass}">${value.toFixed(1)}/10.0</span>
                    `;
                    scoresContainer.appendChild(scoreItem);
                }
                
                // Add summary if present
                if (summary) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'summary-box';
                    summaryDiv.innerHTML = `<strong>üìã Scoring Summary</strong>${summary}`;
                    scoresContainer.appendChild(summaryDiv);
                }
                
                if (hasScores || summary) {
                    scoresSection.classList.remove('hidden');
                } else {
                    scoresSection.classList.add('hidden');
                }
            } else {
                document.getElementById('scores-section').classList.add('hidden');
            }
            
            // Display improvement tips
            if (improvementTips && improvementTips.length > 0) {
                const tipsSection = document.getElementById('improvement-tips-section');
                const tipsContainer = document.getElementById('improvement-tips');
                tipsSection.classList.remove('hidden');
                
                tipsContainer.innerHTML = '';
                improvementTips.forEach(tip => {
                    const tipDiv = document.createElement('div');
                    tipDiv.className = 'improvement-tip';
                    tipDiv.textContent = tip;
                    tipsContainer.appendChild(tipDiv);
                });
            } else {
                document.getElementById('improvement-tips-section').classList.add('hidden');
            }
            
            // Display follow-ups
            if (evaluation.followups && evaluation.followups.length > 0) {
                const followupsSection = document.getElementById('followups-section');
                const followupsList = document.getElementById('followups');
                followupsSection.classList.remove('hidden');
                
                followupsList.innerHTML = '';
                evaluation.followups.forEach(q => {
                    const li = document.createElement('li');
                    li.className = 'followup-question clickable';
                    li.textContent = q;
                    li.style.cursor = 'pointer';
                    li.style.padding = '8px';
                    li.style.margin = '4px 0';
                    li.style.borderRadius = '4px';
                    li.style.backgroundColor = '#f8f9fa';
                    li.style.border = '1px solid #e9ecef';
                    li.style.transition = 'background-color 0.2s';

                    li.addEventListener('mouseenter', () => {
                        li.style.backgroundColor = '#e9ecef';
                    });

                    li.addEventListener('mouseleave', () => {
                        li.style.backgroundColor = '#f8f9fa';
                    });

                    li.addEventListener('click', () => {
                        startNewInterviewWithQuestion(q);
                    });

                    followupsList.appendChild(li);
                });
            } else {
                document.getElementById('followups-section').classList.add('hidden');
            }

            // Display RAGAS metrics
            if (evaluation.ragas) {
                const ragasSection = document.getElementById('ragas-section');
                const ragasContainer = document.getElementById('ragas-metrics');
                ragasSection.classList.remove('hidden');

                ragasContainer.innerHTML = '';
                for (const [metric, value] of Object.entries(evaluation.ragas)) {
                    if (typeof value === 'number') {
                        const metricDiv = document.createElement('div');
                        metricDiv.className = 'ragas-metric';

                        let scoreClass = 'low';
                        if (value >= 0.8) scoreClass = 'high';
                        else if (value >= 0.6) scoreClass = 'medium';

                        metricDiv.innerHTML = `
                            <span>${metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            <span class="score-value ${scoreClass}">${value.toFixed(3)}</span>
                        `;
                        ragasContainer.appendChild(metricDiv);
                    }
                }
            } else {
                document.getElementById('ragas-section').classList.add('hidden');
            }

            // Display LLM-as-Judge results
            if (evaluation.judge) {
                const judgeSection = document.getElementById('judge-section');
                const judgeScore = document.getElementById('judge-score');
                const judgeRationale = document.getElementById('judge-rationale');
                judgeSection.classList.remove('hidden');

                let scoreClass = 'low';
                if (evaluation.judge.score >= 8) scoreClass = 'high';
                else if (evaluation.judge.score >= 6) scoreClass = 'medium';

                judgeScore.innerHTML = `
                    <span>Overall Judge Score</span>
                    <span class="score-value ${scoreClass}">${evaluation.judge.score.toFixed(1)}/10.0</span>
                `;

                judgeRationale.innerHTML = `<strong>Judge Rationale:</strong> ${evaluation.judge.rationale}`;
            } else {
                document.getElementById('judge-section').classList.add('hidden');
            }

            // Show refine button if allowed
            const refineBtn = document.getElementById('refine-btn');
            if (refinementAllowed && !interviewComplete) {
                refineBtn.classList.remove('hidden');
            } else {
                refineBtn.classList.add('hidden');
            }
            
            // Update buttons
            if (interviewComplete) {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('new-interview-btn').classList.remove('hidden');
                showSuccess('üéâ Interview Complete! Great job!');
            } else {
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('new-interview-btn').classList.add('hidden');
            }
        }
        
        function displayGRAILEvaluation(grailEval) {
            if (!grailEval) {
                document.getElementById('grail-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('grail-section').classList.remove('hidden');
            const componentsDiv = document.getElementById('grail-components');
            componentsDiv.innerHTML = '';
            
            // Display each GRAIL component
            const components = [
                { key: 'goal_score', label: 'Goal', icon: 'üéØ' },
                { key: 'resources_score', label: 'Resources', icon: 'üíº' },
                { key: 'actions_score', label: 'Actions', icon: '‚ö°' },
                { key: 'impact_score', label: 'Impact', icon: 'üìä' },
                { key: 'learning_score', label: 'Learning', icon: 'üß†' }
            ];
            
            components.forEach(comp => {
                const score = grailEval[comp.key];
                if (!score) return;
                
                const componentDiv = document.createElement('div');
                componentDiv.className = 'grail-component';
                
                componentDiv.innerHTML = `
                    <div class="grail-header">
                        <span class="grail-title">${comp.icon} ${comp.label}</span>
                        <span class="grail-level ${score.strength_level}">${score.strength_level}</span>
                    </div>
                    <div class="rubric-score-bar">
                        <div class="rubric-score-fill ${getScoreClass(score.score)}" 
                             style="width: ${(score.score/10)*100}%"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <strong>Score:</strong> ${score.score.toFixed(1)}/10
                    </div>
                    ${score.evidence?.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <strong style="font-size: 13px;">Evidence:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                                ${score.evidence.slice(0, 2).map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${score.missing_elements?.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <strong style="font-size: 13px; color: #f39c12;">To Improve:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px; color: #7f8c8d;">
                                ${score.missing_elements.slice(0, 2).map(m => `<li>${m}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                
                componentsDiv.appendChild(componentDiv);
            });
            
            // Display overall GRAIL assessment
            const overallDiv = document.getElementById('grail-overall');
            overallDiv.innerHTML = `
                <strong>üèÜ Overall GRAIL Score: ${grailEval.overall_score.toFixed(1)}/10</strong>
                <p style="margin-top: 10px;">${grailEval.overall_assessment}</p>
                ${Object.keys(grailEval.pm_competency_mapping || {}).length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong style="font-size: 14px;">PM Competencies:</strong>
                        <div style="margin-top: 8px;">
                            ${Object.entries(grailEval.pm_competency_mapping).map(([comp, desc]) => `
                                <div style="padding: 5px 10px; margin: 4px 0; background: #f8f9fa; 
                                            border-radius: 4px; font-size: 13px;">
                                    <strong>${comp}:</strong> ${desc}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function displayConsensusEvaluation(consensus) {
            if (!consensus) {
                document.getElementById('consensus-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('consensus-section').classList.remove('hidden');
            const agentsDiv = document.getElementById('agent-evaluations');
            agentsDiv.innerHTML = '';
            
            // Display individual agent evaluations
            consensus.agent_evaluations?.forEach(agent => {
                const agentCard = document.createElement('div');
                agentCard.className = 'agent-card';
                
                agentCard.innerHTML = `
                    <div class="agent-name">
                        ${agent.agent_name}
                        <span class="agent-confidence">Confidence: ${(agent.confidence * 100).toFixed(0)}%</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0;">
                        <div class="rubric-score-bar" style="flex: 1;">
                            <div class="rubric-score-fill ${getScoreClass(agent.score)}" 
                                 style="width: ${(agent.score/10)*100}%"></div>
                        </div>
                        <span class="score-value ${getScoreClass(agent.score)}">
                            ${agent.score.toFixed(1)}/10
                        </span>
                    </div>
                    <div style="font-size: 13px; color: #5a6c7d; margin-top: 10px;">
                        <em>${agent.rationale}</em>
                    </div>
                    ${agent.key_observations?.length > 0 ? `
                        <div style="margin-top: 10px; font-size: 13px;">
                            <strong>Observations:</strong>
                            ${agent.key_observations.slice(0, 2).map(o => `<div>‚Ä¢ ${o}</div>`).join('')}
                        </div>
                    ` : ''}
                `;
                
                agentsDiv.appendChild(agentCard);
            });
            
            // Display consensus result
            const consensusDiv = document.getElementById('consensus-result');
            consensusDiv.innerHTML = `
                <h4 style="margin-bottom: 15px;">üéØ Consensus Evaluation</h4>
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <strong>Final Score:</strong> ${consensus.final_score.toFixed(1)}/10
                    </div>
                    <div style="flex: 1;">
                        <strong>Confidence:</strong> ${(consensus.confidence * 100).toFixed(0)}%
                    </div>
                </div>
                <div style="padding: 15px; background: white; border-radius: 8px; margin: 10px 0;">
                    <strong>Recommendation:</strong> ${consensus.recommendation}
                </div>
                ${consensus.consensus_strengths?.length > 0 ? `
                    <div style="margin-top: 10px;">
                        <strong>Agreed Strengths:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                            ${consensus.consensus_strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${consensus.consensus_improvements?.length > 0 ? `
                    <div style="margin-top: 10px;">
                        <strong>Areas to Improve:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                            ${consensus.consensus_improvements.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }
        
        function displayAdaptiveDecision(adaptive) {
            if (!adaptive) {
                document.getElementById('adaptive-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('adaptive-section').classList.remove('hidden');
            const contentDiv = document.getElementById('adaptive-content');
            
            const actionLabels = {
                'continue': '‚û°Ô∏è Continue',
                'adjust_difficulty': 'üìä Adjust Difficulty',
                'switch_category': 'üîÑ Switch Category',
                'deep_dive': 'üîç Deep Dive',
                'conclude': 'üèÅ Conclude'
            };
            
            const difficultyLabels = {
                'easier': '‚¨áÔ∏è Easier',
                'same': '‚ûñ Same Level',
                'harder': '‚¨ÜÔ∏è Harder'
            };
            
            contentDiv.innerHTML = `
                <div class="adaptive-action">
                    ${actionLabels[adaptive.action] || adaptive.action}
                </div>
                <div style="margin: 15px 0;">
                    <strong>Reasoning:</strong>
                    <p style="margin-top: 8px; color: #5a6c7d;">${adaptive.reasoning}</p>
                </div>
                <div style="display: flex; gap: 20px; margin-top: 15px;">
                    <div>
                        <strong>Difficulty:</strong>
                        <span style="margin-left: 10px; padding: 4px 12px; border-radius: 12px; 
                                     background: #fff3cd; color: #856404; font-size: 13px;">
                            ${difficultyLabels[adaptive.difficulty_adjustment] || adaptive.difficulty_adjustment}
                        </span>
                    </div>
                    ${adaptive.focus_area ? `
                        <div>
                            <strong>Focus Area:</strong>
                            <span style="margin-left: 10px; padding: 4px 12px; border-radius: 12px; 
                                         background: #d1ecf1; color: #0c5460; font-size: 13px;">
                                ${adaptive.focus_area}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function displayCoachingFeedback(coaching) {
            if (!coaching) {
                document.getElementById('coaching-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('coaching-section').classList.remove('hidden');
            const contentDiv = document.getElementById('coaching-content');
            const patternsDiv = document.getElementById('coaching-patterns');
            
            // Parse the feedback text to extract structured sections
            let feedbackHTML = '';
            const feedbackText = coaching.feedback_text || '';
            
            // Split feedback into numbered sections
            const sections = feedbackText.split(/(?=\d+\.\s*\*\*)/);
            
            sections.forEach(section => {
                if (!section.trim()) return;
                
                // Extract section number, title, and content
                const match = section.match(/^(\d+)\.\s*\*\*(.*?)\*\*:?\s*(.*)/s);
                if (match) {
                    const [, number, title, content] = match;
                    
                    // Determine section style based on title
                    let sectionStyle = '';
                    let icon = '';
                    
                    if (title.includes('Positive Recognition')) {
                        sectionStyle = 'background: #e8f5e9; border-left: 4px solid #4caf50;';
                        icon = '‚úÖ';
                    } else if (title.includes('Improvement Areas')) {
                        sectionStyle = 'background: #fff3e0; border-left: 4px solid #ff9800;';
                        icon = 'üìù';
                    } else if (title.includes('Actionable Next Steps')) {
                        sectionStyle = 'background: #e3f2fd; border-left: 4px solid #2196f3;';
                        icon = 'üéØ';
                    } else if (title.includes('Encouraging Conclusion')) {
                        sectionStyle = 'background: #f3e5f5; border-left: 4px solid #9c27b0;';
                        icon = 'üåü';
                    }
                    
                    // Format content with proper line breaks and bullet points
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/- \*\*(.*?)\*\*:/g, '<br><br><strong>‚Ä¢ $1:</strong>')
                        .replace(/- (.*?)(?=\n|$)/g, '<br>‚Ä¢ $1')
                        .trim();
                    
                    feedbackHTML += `
                        <div style="margin-bottom: 15px; padding: 15px; border-radius: 8px; ${sectionStyle}">
                            <h4 style="margin: 0 0 10px 0; color: #333; display: flex; align-items: center;">
                                <span style="margin-right: 8px;">${icon}</span>
                                ${title}
                            </h4>
                            <div style="line-height: 1.8; color: #555;">
                                ${formattedContent}
                            </div>
                        </div>
                    `;
                }
            });
            
            // If no structured sections found, display as-is
            if (!feedbackHTML) {
                feedbackHTML = `
                    <div style="padding: 15px; background: white; border-radius: 8px; line-height: 1.8;">
                        ${feedbackText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                    </div>
                `;
            }
            
            contentDiv.innerHTML = feedbackHTML;
            
            // Add encouragement message if present
            if (coaching.encouragement_message) {
                contentDiv.innerHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; 
                                border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h4 style="margin: 0 0 8px 0; color: #2e7d32;">
                            üíö Encouragement
                        </h4>
                        <p style="margin: 0; line-height: 1.6; color: #555;">
                            ${coaching.encouragement_message}
                        </p>
                    </div>
                `;
            }
            
            // Add adapted follow-ups if present
            if (coaching.adapted_followups?.length > 0) {
                contentDiv.innerHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #f5f5f5; 
                                border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">
                            üé§ Personalized Follow-up Questions
                        </h4>
                        <ul style="margin: 0; padding-left: 25px; line-height: 1.8;">
                            ${coaching.adapted_followups.map(f => `
                                <li style="margin-bottom: 8px; color: #555;">${f}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Display coaching patterns if available (but keep them minimal)
            if (coaching.coaching_patterns && Object.keys(coaching.coaching_patterns).length > 0) {
                const nonEmptyPatterns = Object.entries(coaching.coaching_patterns)
                    .filter(([, examples]) => Array.isArray(examples) && examples.length > 0);
                
                if (nonEmptyPatterns.length > 0) {
                    patternsDiv.innerHTML = `
                        <div style="margin-top: 15px; padding: 12px; background: #fafafa; 
                                    border-radius: 8px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 8px 0; font-size: 13px; color: #666;">
                                üìö Coaching Methodology
                            </h4>
                            <div style="font-size: 12px; color: #888;">
                                Based on Dr. Nancy's proven PM coaching framework
                            </div>
                        </div>
                    `;
                } else {
                    patternsDiv.innerHTML = '';
                }
            } else {
                patternsDiv.innerHTML = '';
            }
        }
        
        function displayPerformanceMetrics(metrics) {
            if (!metrics) {
                document.getElementById('performance-section').classList.add('hidden');
                return;
            }
            
            document.getElementById('performance-section').classList.remove('hidden');
            const contentDiv = document.getElementById('performance-content');
            
            contentDiv.innerHTML = `
                <div class="metric-item">
                    <span class="metric-label">Average Score</span>
                    <span class="score-value ${getScoreClass(metrics.avg_score)}">
                        ${metrics.avg_score.toFixed(1)}/10
                    </span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Performance Trend</span>
                    <span class="trend-badge ${metrics.trend}">${metrics.trend}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Questions Answered</span>
                    <span>${metrics.questions_answered}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Time Spent</span>
                    <span>${metrics.time_spent_minutes.toFixed(0)} minutes</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Confidence Level</span>
                    <span>${(metrics.confidence_level * 100).toFixed(0)}%</span>
                </div>
                ${metrics.strengths?.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e6ed;">
                        <strong>Key Strengths:</strong>
                        <div style="margin-top: 8px;">
                            ${metrics.strengths.map(s => `
                                <span style="display: inline-block; padding: 4px 12px; margin: 4px; 
                                             background: #d4edda; color: #155724; border-radius: 12px; 
                                             font-size: 13px;">${s}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                ${metrics.weaknesses?.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong>Focus Areas:</strong>
                        <div style="margin-top: 8px;">
                            ${metrics.weaknesses.map(w => `
                                <span style="display: inline-block; padding: 4px 12px; margin: 4px; 
                                             background: #fff3cd; color: #856404; border-radius: 12px; 
                                             font-size: 13px;">${w}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function getScoreClass(score) {
            if (score >= 8) return 'high';
            if (score >= 6) return 'medium';
            return 'low';
        }
        
        function nextQuestion() {
            displayQuestion();
            showScreen('question-screen');
        }
        
        function showRefinementSection() {
            document.getElementById('refinement-section').classList.remove('hidden');
            document.getElementById('main-buttons').classList.add('hidden');
            document.getElementById('refined-answer').value = currentAnswer;
            document.getElementById('refinement-count-badge').textContent = `Attempt ${refinementCount + 1}/${maxRefinements}`;
        }
        
        function skipRefinement() {
            document.getElementById('refinement-section').classList.add('hidden');
            document.getElementById('main-buttons').classList.remove('hidden');
        }
        
        async function submitRefinedAnswer() {
            const refinedAnswer = document.getElementById('refined-answer').value.trim();
            
            if (!refinedAnswer) {
                showError('Please provide a refined answer');
                return;
            }
            
            showScreen('loading');
            
            try {
                const response = await fetch(`${API_URL}/behavioral/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: refinedAnswer,
                        is_refinement: true,
                        refinement_count: refinementCount + 1,
                        options: {
                            k: 5,
                            prefer_coach: true,
                            do_judge: true,
                            do_ragas: true
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Submit refined answer failed:', errorText);
                    throw new Error(`Failed to submit refined answer: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Refined answer evaluated:', data);
                
                // Hide refinement section
                document.getElementById('refinement-section').classList.add('hidden');
                document.getElementById('main-buttons').classList.remove('hidden');
                
                // Update the display with new evaluation
                displayEvaluation(data.evaluation, data);
                currentAnswer = refinedAnswer;  // Update stored answer
                
                showSuccess('Refined answer evaluated! Your score has been updated.');
                showScreen('evaluation-screen');
            } catch (error) {
                console.error('Error submitting refined answer:', error);
                showError(error.message || 'Failed to submit refined answer');
                showScreen('evaluation-screen');
            }
        }

        async function startNewInterviewWithQuestion(question) {
            // Confirm with user before starting new interview
            if (!confirm('This will start a new interview session with the selected follow-up question. Continue?')) {
                return;
            }

            try {
                showScreen('loading');

                // Start a new behavioral interview session
                const response = await fetch(`${API_URL}/behavioral/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        total_questions: 5,
                        difficulty: 'senior',
                        custom_question: question  // Pass the follow-up question as a custom question
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Start new interview failed:', errorText);
                    throw new Error(`Failed to start new interview: ${response.status}`);
                }

                const data = await response.json();
                console.log('New interview started with follow-up question:', data);

                // Reset state for new interview
                sessionId = data.session_id;
                currentQuestion = data.question;
                currentAnswer = '';
                refinementCount = 0;
                interviewComplete = false;

                // Hide previous evaluation sections
                document.getElementById('template-answer-section').classList.add('hidden');
                document.getElementById('improvement-tips-section').classList.add('hidden');
                document.getElementById('refinement-section').classList.add('hidden');
                document.getElementById('main-buttons').classList.remove('hidden');

                // Display the new question manually (instead of calling displayQuestion)
                if (currentQuestion) {
                    document.getElementById('question-number').textContent =
                        `Question ${currentQuestion.question_index + 1} of ${currentQuestion.total_questions}`;
                    document.getElementById('category-badge').textContent = currentQuestion.category;
                    document.getElementById('question-text').textContent = currentQuestion.question;
                    document.getElementById('answer').value = '';
                }

                // Show the question screen
                showScreen('question-screen');
                showSuccess('New interview started with your selected follow-up question!');

            } catch (error) {
                console.error('Error starting new interview:', error);
                showError(error.message || 'Failed to start new interview');
                showScreen('evaluation-screen');  // Stay on current screen
            }
        }

        function resetInterview() {
            sessionId = '';
            currentQuestion = null;
            currentAnswer = '';
            refinementCount = 0;
            interviewComplete = false;
            document.getElementById('template-answer-section').classList.add('hidden');
            document.getElementById('improvement-tips-section').classList.add('hidden');
            document.getElementById('refinement-section').classList.add('hidden');
            document.getElementById('main-buttons').classList.remove('hidden');
            showScreen('start-screen');
        }
    </script>
</body>
</html>